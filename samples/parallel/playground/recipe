#	Controlled by MAXJOBS variable.
#
#	If MAXJOBS is not defined then parallel_depends_on() works as
#	usual depends-on. If MAXJOBS is defined then parallel_depends_on()
#	builds each target in the separate process all in parallel.
#
#	The standard streams which are redirected to the files are
#	sequentialized. In order to obtain a valid log one of the standard
#	streams should be used for logging followed with redirection
#	of this stream to a file.

parallel_depends_on ()
{
	if test -n "$MAXJOBS"		# jobs to be controlled internally
	then
		OLOGS=
		ELOGS=

		for DEP in $*
		do
			if test -t 1
			then		# stdout is not captured
				if test -t 2
				then		# stderr is not captured
					redo $DEP &
				else		# stderr is captured
					ELOG=$(mktemp /tmp/redoXXXXXXXX)
					ELOGS="$ELOGS $ELOG"
					redo $DEP 2>$ELOG &
				fi
			else		# stdout is captured		
				OLOG=$(mktemp /tmp/redoXXXXXXXX)
				OLOGS="$OLOGS $OLOG"
				if test -t 2
				then		# stderr is not captured
					redo $DEP >$OLOG &
				else		# stderr is captured
					if test /proc/self/fd/1 -ef /proc/self/fd/2
					then		# single output file
						redo $DEP >$OLOG 2>&1 &
					else		# different output files
						ELOG=$(mktemp /tmp/redoXXXXXXXX)
						ELOGS="$ELOGS $ELOG"
						redo $DEP >$OLOG 2>$ELOG &
					fi
				fi
			fi
		done
		wait

		if test -n "$OLOGS"
		then
			cat $OLOGS
			rm -f $OLOGS
		fi

		if test -n "$ELOGS"
		then
			cat $ELOGS >&2
			rm -f $ELOGS
		fi
	fi

	depends-on $*
}

echo $1

parallel_depends_on $DEPS

lua -e 'local t = os.clock() + '$DELAY' repeat until os.clock() > t'
cat $DEPS > $3

echo $1 ok >&2

